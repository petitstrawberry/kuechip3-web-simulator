'use strict'

let fHasSetMemory = false       // メモリセット済み
let fExecInsts    = false       // 実行中
let state = {}

// ===== event handler =====
$('#btn_set_memory').on('click', () => {
    log('set memory data')

    const insts = document.getElementById('inst').value
    const instList = insts.replace(/^\n/gm, '').split('\n')

    const psg = getProcessingInstance()
    psg.SetBinary( instList )

    fHasSetMemory = true

    dumpMem()
})

function execPhase() { log('execute 1 phase'); getStateFromForm(); update("phase"); dump() }
function execInst()  { log('execute 1 instruction'); getStateFromForm(); update("inst") ; dump() }
function execAll()   { log('execution all...'); getStateFromForm(); update("all")  ; dump() }


$('#btn_start_execution').on('click', () => {
    log('start execution')
    fExecInsts = true;
    getStateFromForm();
    execInstsRecursively();
})

$('#btn_stop_execution').on('click', () => {
    log('stop execution')
    fExecInsts = false
})


// ===== funtions =====
function execInstsRecursively() {
    const psg = getProcessingInstance()

    if ( ! fExecInsts ) { return }

    for(let i = 0; i < 1000; i++) {
        update("inst")
        state = psg.State()         // instead of dump()
    }

    dump()

    setTimeout( () => { execInstsRecursively() }, 0 )
}


function update( mode ) {
    if ( ! fHasSetMemory ) {
        log( "Memory data has not been set." )
        return
    }

    // mode check
    if      ( mode === "phase" ) { /* log("Exec by 1 phase")               */ }
    else if ( mode === "inst"  ) { /* log("Exec by 1 inst")                */ }
    else if ( mode === "all"   ) { /* log("Exec all")                      */ }
    else                         {    log("internal error: invalid mode.")    }

    // call simulator
    const psg = getProcessingInstance()
    psg.Update(state, mode)        // (state, mode)
}


function getStateFromForm() {
    // make associative array of KueState
    state.pc  = parseInt(document.getElementById("PC"  ).value, 16)
    state.ir  = parseInt(document.getElementById("IR"  ).value, 16)
    state.sp  = parseInt(document.getElementById("SP"  ).value, 16)
    state.acc = parseInt(document.getElementById("ACC" ).value, 16)
    state.ix  = parseInt(document.getElementById("IX"  ).value, 16)
    state.mar = parseInt(document.getElementById("MAR" ).value, 16)

    state.flagCf = ( document.getElementById("CF").value === '1' )
    state.flagVf = ( document.getElementById("VF").value === '1' )
    state.flagNf = ( document.getElementById("NF").value === '1' )
    state.flagZf = ( document.getElementById("ZF").value === '1' )

    state.ibuf         = parseInt(document.getElementById("IBUF").value, 16)
    state.obuf         = parseInt(document.getElementById("OBUF").value, 16)
    state.ibuf_re      = ( document.getElementById("IBUF_RE"     ).value === '1' )
    state.obuf_we      = ( document.getElementById("OBUF_WE"     ).value === '1' )
    state.ibuf_flg_clr = ( document.getElementById("IBUF_FLG_CLR").value === '1' )
}


function dump() {
    // dump simulator data
    dumpReg()
    dumpMem()
    dumpPhase()
}


function dumpReg() {
    const psg = getProcessingInstance()
    const state = psg.State()
    document.getElementById("PC").value  = toHex(state.pc , 4)
    document.getElementById("IR").value  = toHex(state.ir , 2)
    document.getElementById("SP").value  = toHex(state.sp , 4)
    document.getElementById("ACC").value = toHex(state.acc, 4)
    document.getElementById("IX").value  = toHex(state.ix , 4)
    document.getElementById("MAR").value = toHex(state.mar, 4)

    document.getElementById("CF").value  = state.flagCf ? 1 : 0
    document.getElementById("VF").value  = state.flagVf ? 1 : 0
    document.getElementById("NF").value  = state.flagNf ? 1 : 0
    document.getElementById("ZF").value  = state.flagZf ? 1 : 0

    document.getElementById("IBUF").value         = toHex(state.ibuf, 2)
    document.getElementById("OBUF").value         = toHex(state.obuf, 2)
    document.getElementById("IBUF_RE").value      = state.ibuf_re      ? 1 : 0
    document.getElementById("OBUF_WE").value      = state.obuf_we      ? 1 : 0
    document.getElementById("IBUF_FLG_CLR").value = state.ibuf_flg_clr ? 1 : 0
}

function dumpMem() {
    const psg = getProcessingInstance()
    const state = psg.State()
    const memStr = []

    // 最後の有効データが存在する番地を調べる
    let lastIdx = 0
    for (let idx = 0xfffe / 2; idx >= 0; idx--) {
        if( state.mem[idx] !== 0 ) {
            lastIdx = idx
            break
        }
    }

    // 最後の有効データまでを出力形式に整形
    for (let idx = 0; idx <= lastIdx; idx++) {
        const current = state.currentInstAddr
        const styleBegin = ( idx * 2 === current ) ? '<div style="background: steelblue">' : '<div>'
        const styleEnd   = '</div>'
        memStr.push(
            styleBegin + toHex(idx * 2, 4) + " :  " + toHex(state.mem[idx], 4) + styleEnd
        )
    }

    // 結合して表示
    document.getElementById("mem").innerHTML = memStr.join('')
}

function dumpPhase() {
    const psg = getProcessingInstance()
    const state = psg.State()
    document.getElementById("Phase").value = state.phase
}


// static local な値を持つクロージャ
const getProcessingInstance = (() => {
    let psg = null // processing instance

    return () => {
        if ( ! psg ) {
            psg = Processing.getInstanceById('kuesim')
            log( psg ?
                 "Success to get the instance of processing." :
                 "Failed to get the instance of processing."
               )
        }

        return psg
    }
})()


// ========== utilities ==========
function pad0 ( value, digit ) {
    return value.padStart(digit, '0')
}

function toHex( value, digit ) {
    return "0x" + pad0(value.toString(16), digit)
}


// log
function log(str) {
    // developer tool への出力 (F12 等で確認)
    console.log(str)

    const now = new Date()
    const hour = now.getHours().toString().padStart(2, '0')
    const minute = now.getMinutes().toString().padStart(2, '0')

    // ログエリアへの出力
    document.getElementById("log").innerText += `[${hour}:${minute}] ${str}${'\n'}`

    // 自動スクロール
    const logArea = document.getElementById("log")
    logArea.scrollTop = logArea.scrollHeight  // scroll to the bottom
}

